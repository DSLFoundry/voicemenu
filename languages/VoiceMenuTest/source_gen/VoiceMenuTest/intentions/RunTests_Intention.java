package VoiceMenuTest.intentions;

/*Generated by MPS */

import jetbrains.mps.intentions.AbstractIntentionDescriptor;
import jetbrains.mps.openapi.intentions.IntentionFactory;
import java.util.Collection;
import jetbrains.mps.openapi.intentions.IntentionExecutable;
import jetbrains.mps.openapi.intentions.Kind;
import jetbrains.mps.smodel.SNodePointer;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.openapi.editor.EditorContext;
import java.util.Collections;
import jetbrains.mps.intentions.AbstractIntentionExecutable;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import java.util.Objects;
import jetbrains.mps.samples.VoiceMenu.behavior.Event__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.openapi.intentions.IntentionDescriptor;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public final class RunTests_Intention extends AbstractIntentionDescriptor implements IntentionFactory {
  private Collection<IntentionExecutable> myCachedExecutable;
  public RunTests_Intention() {
    super(Kind.NORMAL, true, new SNodePointer("r:e62e7d7f-d516-4f0b-946c-e54a37d62a24(VoiceMenuTest.intentions)", "8281000289632534074"));
  }
  @Override
  public String getPresentation() {
    return "RunTests";
  }
  @Override
  public boolean isApplicable(final SNode node, final EditorContext editorContext) {
    return true;
  }
  @Override
  public boolean isSurroundWith() {
    return false;
  }
  public Collection<IntentionExecutable> instances(final SNode node, final EditorContext context) {
    if (myCachedExecutable == null) {
      myCachedExecutable = Collections.<IntentionExecutable>singletonList(new IntentionImplementation());
    }
    return myCachedExecutable;
  }
  /*package*/ final class IntentionImplementation extends AbstractIntentionExecutable {
    public IntentionImplementation() {
    }
    @Override
    public String getDescription(final SNode node, final EditorContext editorContext) {
      return "Run Tests";
    }
    @Override
    public void execute(final SNode node, final EditorContext editorContext) {
      Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(node, LINKS.commands$xTQf), CONCEPTS.TestStep$9N)).visitAll(new IVisitor<SNode>() {
        public void visit(SNode it) {
          SPropertyOperations.setEnum(SLinkOperations.getTarget(it, LINKS.evaluation$VA5f), PROPS.result$T6Kx, 0x72ec05e3886dfc17L, "Unknown");
          SPropertyOperations.assign(SLinkOperations.getTarget(it, LINKS.evaluation$VA5f), PROPS.message$T6Lv, "");
        }
      });

      SNode currentMenu = SLinkOperations.getTarget(SLinkOperations.getTarget(node, LINKS.workspaceToTest$xMNi), LINKS.bodyMenu$8UCv);
      final Wrappers._T<SNode> currentEvent = new Wrappers._T<SNode>(null);
      for (SNode step : Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(node, LINKS.commands$xTQf), CONCEPTS.TestStep$9N))) {
        if (SNodeOperations.isInstanceOf(step, CONCEPTS.Press$kW)) {
          final String key = SPropertyOperations.getString(SNodeOperations.cast(step, CONCEPTS.Press$kW), PROPS.key$S$4E);
          currentEvent.value = ListSequence.fromList(SLinkOperations.getChildren(currentMenu, LINKS.events$AIPs)).findFirst(new IWhereFilter<SNode>() {
            public boolean accept(SNode it) {
              return Objects.equals(SPropertyOperations.getString(it, PROPS.trigger$zpYt), key);
            }
          });
          if ((currentEvent.value == null)) {
            SPropertyOperations.setEnum(SLinkOperations.getTarget(step, LINKS.evaluation$VA5f), PROPS.result$T6Kx, 0x72ec05e3886dfc14L, "Failure");
            SPropertyOperations.assign(SLinkOperations.getTarget(step, LINKS.evaluation$VA5f), PROPS.message$T6Lv, "No event triggered by " + key + " is available in the menu " + Event__BehaviorDescriptor.getFullName_id7bG1ue8uybI.invoke(SLinkOperations.getTarget(SNodeOperations.getNodeAncestor(currentMenu, CONCEPTS.Activity$oQ, false, false), LINKS.event$gjCV)));
            return;
          }
          SNode currentActivity = ListSequence.fromList((SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(node, LINKS.workspaceToTest$xMNi), CONCEPTS.Activity$oQ, false, new SAbstractConcept[]{}))).where(new IWhereFilter<SNode>() {
            public boolean accept(SNode it) {
              return Objects.equals(SLinkOperations.getTarget(it, LINKS.event$gjCV), currentEvent.value);
            }
          }).first();
          if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(currentActivity, LINKS.commands$giUr), CONCEPTS.Menu$bP)) {
            currentMenu = SNodeOperations.as(SLinkOperations.getTarget(currentActivity, LINKS.commands$giUr), CONCEPTS.Menu$bP);
          }
        }
        if (SNodeOperations.isInstanceOf(step, CONCEPTS.Assert$T3)) {
          if (!(Objects.equals(SLinkOperations.getTarget(SNodeOperations.cast(step, CONCEPTS.Assert$T3), LINKS.expectedEvent$ZeYz), currentEvent.value))) {
            SPropertyOperations.setEnum(SLinkOperations.getTarget(step, LINKS.evaluation$VA5f), PROPS.result$T6Kx, 0x72ec05e3886dfc14L, "Failure");
            SPropertyOperations.assign(SLinkOperations.getTarget(step, LINKS.evaluation$VA5f), PROPS.message$T6Lv, "Expected " + Event__BehaviorDescriptor.getFullName_id7bG1ue8uybI.invoke(SLinkOperations.getTarget(SNodeOperations.cast(step, CONCEPTS.Assert$T3), LINKS.expectedEvent$ZeYz)) + " but was in " + Event__BehaviorDescriptor.getFullName_id7bG1ue8uybI.invoke(currentEvent.value));
            return;
          }
        }
        SPropertyOperations.setEnum(SLinkOperations.getTarget(step, LINKS.evaluation$VA5f), PROPS.result$T6Kx, 0x72ec05e3886dfc13L, "Success");
      }
    }
    @Override
    public IntentionDescriptor getDescriptor() {
      return RunTests_Intention.this;
    }
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink commands$xTQf = MetaAdapterFactory.getContainmentLink(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3886dfc0cL, 0x72ec05e38870528cL, "commands");
    /*package*/ static final SContainmentLink evaluation$VA5f = MetaAdapterFactory.getContainmentLink(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3886dfc0fL, 0x72ec05e3886dfc64L, "evaluation");
    /*package*/ static final SReferenceLink workspaceToTest$xMNi = MetaAdapterFactory.getReferenceLink(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3886dfc0cL, 0x72ec05e388705231L, "workspaceToTest");
    /*package*/ static final SContainmentLink bodyMenu$8UCv = MetaAdapterFactory.getContainmentLink(0x4bc750d756884f52L, 0xb7d5b263a3393a24L, 0x5b6b060cf40204c8L, 0x5b6b060cf40204ebL, "bodyMenu");
    /*package*/ static final SContainmentLink events$AIPs = MetaAdapterFactory.getContainmentLink(0x4bc750d756884f52L, 0xb7d5b263a3393a24L, 0x5b6b060cf3fde308L, 0x5b6b060cf3fde688L, "events");
    /*package*/ static final SReferenceLink event$gjCV = MetaAdapterFactory.getReferenceLink(0x4bc750d756884f52L, 0xb7d5b263a3393a24L, 0x5b6b060cf3fde68dL, 0x5b6b060cf3fe08f3L, "event");
    /*package*/ static final SContainmentLink commands$giUr = MetaAdapterFactory.getContainmentLink(0x4bc750d756884f52L, 0xb7d5b263a3393a24L, 0x5b6b060cf3fde68dL, 0x5b6b060cf3fe08d2L, "commands");
    /*package*/ static final SReferenceLink expectedEvent$ZeYz = MetaAdapterFactory.getReferenceLink(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3887030a6L, 0x72ec05e38870a891L, "expectedEvent");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept TestStep$9N = MetaAdapterFactory.getConcept(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3886dfc0fL, "VoiceMenuTest.structure.TestStep");
    /*package*/ static final SConcept Press$kW = MetaAdapterFactory.getConcept(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3886dfc11L, "VoiceMenuTest.structure.Press");
    /*package*/ static final SConcept Activity$oQ = MetaAdapterFactory.getConcept(0x4bc750d756884f52L, 0xb7d5b263a3393a24L, 0x5b6b060cf3fde68dL, "jetbrains.mps.samples.VoiceMenu.structure.Activity");
    /*package*/ static final SConcept Menu$bP = MetaAdapterFactory.getConcept(0x4bc750d756884f52L, 0xb7d5b263a3393a24L, 0x5b6b060cf3fde308L, "jetbrains.mps.samples.VoiceMenu.structure.Menu");
    /*package*/ static final SConcept Assert$T3 = MetaAdapterFactory.getConcept(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3887030a6L, "VoiceMenuTest.structure.Assert");
  }

  private static final class PROPS {
    /*package*/ static final SProperty result$T6Kx = MetaAdapterFactory.getProperty(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3886dfc10L, 0x72ec05e3886dfc1bL, "result");
    /*package*/ static final SProperty message$T6Lv = MetaAdapterFactory.getProperty(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3886dfc10L, 0x72ec05e3886dfc1dL, "message");
    /*package*/ static final SProperty key$S$4E = MetaAdapterFactory.getProperty(0x25057fc953374f2eL, 0x9703a17097079193L, 0x72ec05e3886dfc11L, 0x72ec05e3887030a4L, "key");
    /*package*/ static final SProperty trigger$zpYt = MetaAdapterFactory.getProperty(0x4bc750d756884f52L, 0xb7d5b263a3393a24L, 0x5b6b060cf3fde30cL, 0x5b6b060cf3fde310L, "trigger");
  }
}
